<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logic101 | Engine</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg: #000;
            --accent: #ab9ff2;
            --border: #1a1a1a;
            --font: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
        }

        body, html {
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: #fff;
            font-family: var(--font);
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        #app-shell {
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        #stage {
            flex: 1;
            overflow-y: auto;
            padding: 80px 25px 140px 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            scrollbar-width: none;
        }

        #stage::-webkit-scrollbar {
            display: none;
        }

        .view-layer {
            display: none;
            width: 100%;
            max-width: 480px;
            animation: slideIn 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .view-layer.active {
            display: block;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-size: 34px;
            font-weight: 900;
            letter-spacing: 8px;
            text-transform: uppercase;
            text-align: center;
            margin-bottom: 60px;
            background: linear-gradient(180deg, #fff 0%, #333 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .module-card {
            background: #050505;
            border: 1px solid var(--border);
            padding: 45px 35px;
            border-radius: 45px;
            margin-bottom: 25px;
            position: relative;
            transition: transform 0.3s ease;
        }

        .module-card:active {
            transform: scale(0.98);
        }

        .module-card label {
            display: block;
            color: #555;
            font-size: 11px;
            font-weight: 900;
            letter-spacing: 4px;
            text-transform: uppercase;
            margin-bottom: 20px;
        }

        .module-card .data {
            font-size: 48px;
            font-weight: 900;
            color: var(--accent);
            line-height: 1;
        }

        .node-item {
            background: #080808;
            border: 1px solid var(--border);
            padding: 25px;
            border-radius: 25px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .node-info h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 800;
            letter-spacing: 1px;
        }

        .node-info p {
            margin: 5px 0 0 0;
            font-size: 10px;
            color: #444;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 110px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-bottom: 30px;
            z-index: 100;
        }

        .nav-trigger {
            background: none;
            border: none;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: 0.3s;
            flex: 1;
            outline: none;
        }

        .nav-trigger.active {
            color: var(--accent);
        }

        .nav-trigger svg {
            width: 26px;
            height: 26px;
            margin-bottom: 8px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 900;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        #chat-history {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 420px;
            overflow-y: auto;
            padding: 15px;
            margin-bottom: 25px;
            scrollbar-width: none;
        }

        #chat-history::-webkit-scrollbar {
            display: none;
        }

        .ai-bubble {
            background: var(--accent);
            color: #000;
            padding: 20px 25px;
            border-radius: 25px 25px 25px 8px;
            align-self: flex-start;
            font-size: 15px;
            font-weight: 600;
            line-height: 1.6;
            max-width: 80%;
            box-shadow: 0 10px 30px rgba(171, 159, 242, 0.1);
        }

        .user-bubble {
            background: #111;
            color: #fff;
            padding: 20px 25px;
            border-radius: 25px 25px 8px 25px;
            align-self: flex-end;
            border: 1px solid var(--border);
            font-size: 15px;
            max-width: 80%;
        }

        .input-container {
            display: flex;
            gap: 15px;
            width: 100%;
            background: #080808;
            padding: 10px;
            border-radius: 25px;
            border: 1px solid var(--border);
        }

        #user-input {
            background: transparent;
            border: none;
            color: #fff;
            padding: 15px;
            flex: 1;
            outline: none;
            font-family: var(--font);
            font-size: 16px;
            font-weight: 500;
        }

        .send-btn {
            background: var(--accent);
            border: none;
            border-radius: 18px;
            width: 55px;
            height: 55px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        #loading-indicator {
            font-size: 10px;
            font-weight: 900;
            color: var(--accent);
            letter-spacing: 2px;
            margin-bottom: 10px;
            display: none;
        }

        code {
            display: block;
            background: #000;
            color: #fff;
            padding: 20px;
            border-radius: 15px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 13px;
            border: 1px solid #222;
            white-space: pre-wrap;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
            box-shadow: 0 0 10px var(--accent);
        }
    </style>
</head>
<body>

    <div id="app-shell">
        <main id="stage">
            <section id="home" class="view-layer active">
                <h1>Hub</h1>
                <div class="module-card">
                    <label>Logic Progress</label>
                    <div class="data" id="home-progress">0%</div>
                </div>
                <div class="module-card">
                    <label>Uptime (Cycles)</label>
                    <div class="data" id="home-uptime">00:00:00</div>
                </div>
            </section>

            <section id="search" class="view-layer">
                <h1>Find</h1>
                <div class="module-card" style="padding: 15px 25px; border-radius: 30px;">
                    <label>Directory Query</label>
                    <input type="text" id="node-search" placeholder="Search Logic Nodes..." style="background:transparent; border:none; color:#fff; width:100%; font-size:18px; outline:none; font-weight:700;">
                </div>
                <div id="course-list">
                    <div class="module-card" onclick="loadCourse('python-101')" style="cursor:pointer; border: 1px solid var(--accent);">
                        <label>Available Protocol</label>
                        <div class="data" style="font-size:28px;">Python Architect</div>
                    </div>
                </div>
            </section>

            <section id="course-view" class="view-layer">
                <h1 id="course-title">Protocol</h1>
                <div id="course-nodes"></div>
            </section>

            <section id="ai" class="view-layer">
                <h1>Lab</h1>
                <div class="module-card" style="padding: 25px; min-height: 600px; display: flex; flex-direction: column;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom: 1px solid #111; padding-bottom: 15px;">
                        <div style="display:flex; align-items:center;">
                            <span class="status-dot"></span>
                            <label style="margin:0; font-size:12px; color:var(--accent);">ERTY_VAULT_ACTIVE</label>
                        </div>
                        <div id="loading-indicator">SYNCING_VAULT...</div>
                    </div>
                    <div id="chat-history"></div>
                    <div class="input-container">
                        <input type="text" id="user-input" placeholder="Enter logic string..." onkeydown="if(event.key === 'Enter') handleUserInput()">
                        <button class="send-btn" onclick="handleUserInput()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>
                    </div>
                </div>
            </section>
        </main>

        <nav class="nav-bar">
            <button class="nav-trigger active" onclick="navigate('home')">
                <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>
                <span class="nav-label">Hub</span>
            </button>
            <button class="nav-trigger" onclick="navigate('search')">
                <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <span class="nav-label">Find</span>
            </button>
            <button class="nav-trigger" onclick="navigate('ai')">
                <svg viewBox="0 0 24 24"><path d="M12 15a6 6 0 1 0 0-12 6 6 0 0 0 0 12z"></path></svg>
                <span class="nav-label">Lab</span>
            </button>
        </nav>
    </div>

    <script src="data.js"></script>
    <script>
        const SUPABASE_URL = "https://homkmdnutdhmwjpojspw.supabase.co";
        const SUPABASE_ANON = "sb_publishable_ghgy1pXBtqm0ZuiDAJcFgw_ipx94lPC";
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

        let chatHistory = [];
        let isProcessing = false;
        let activeNodeId = null;
        let vaultKey = null;

        async function syncVault() {
            document.getElementById('loading-indicator').style.display = 'block';
            try {
                const { data, error } = await _supabase.rpc('get_service_key', { target_name: 'GEMINI_CORE' });
                if (data) {
                    vaultKey = data;
                    document.getElementById('loading-indicator').style.display = 'none';
                } else {
                    console.error("VAULT_SYNC_FAILED", error);
                }
            } catch (err) {
                console.error("RPC_CALL_ERROR", err);
            }
        }

        async function handleUserInput(forcedText = null) {
            if (!vaultKey) await syncVault();
            if (isProcessing || !vaultKey) return;

            const input = document.getElementById('user-input');
            const text = forcedText || input.value.trim();
            if (!text) return;

            if (!forcedText) input.value = '';
            isProcessing = true;
            document.getElementById('loading-indicator').innerText = "THINKING...";
            document.getElementById('loading-indicator').style.display = 'block';
            
            renderMessage('user', text);
            chatHistory.push({ role: 'user', parts: [{ text: text }] });

            const sys = "You are ERTY, a knowledgeable AI architect created by Frio. User is learning Python. Explain the requested node simply, provide one clean code block with NO comments, and ask exactly one quiz question. If the user answers correctly, you MUST start your response with 'LOGIC_VALIDATED'.";

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${vaultKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: chatHistory,
                        systemInstruction: { parts: [{ text: sys }] }
                    })
                });

                const resData = await response.json();
                const aiText = resData.candidates[0].content.parts[0].text;
                
                renderMessage('model', aiText);
                chatHistory.push({ role: 'model', parts: [{ text: aiText }] });

                if (aiText.includes("LOGIC_VALIDATED") && activeNodeId) {
                    localStorage.setItem(activeNodeId, 'true');
                    updateHomeStats();
                }
            } catch (e) {
                renderMessage('model', "VAULT_ERROR: Protocol logic failed.");
            } finally {
                isProcessing = false;
                document.getElementById('loading-indicator').style.display = 'none';
            }
        }

        function renderMessage(role, text) {
            const hist = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = role === 'user' ? 'user-bubble' : 'ai-bubble';
            const formattedText = text.replace(/```([\s\S]*?)```/g, '<code>$1</code>');
            div.innerHTML = formattedText;
            hist.appendChild(div);
            hist.scrollTop = hist.scrollHeight;
        }

        function navigate(id) {
            document.querySelectorAll('.view-layer').forEach(l => l.classList.remove('active'));
            document.querySelectorAll('.nav-trigger').forEach(b => b.classList.remove('active'));
            const target = document.getElementById(id);
            if (target) target.classList.add('active');
            const triggers = document.querySelectorAll('.nav-trigger');
            if (id === 'home') triggers[0].classList.add('active');
            if (id === 'search') triggers[1].classList.add('active');
            if (id === 'ai') triggers[2].classList.add('active');
        }

        function loadCourse(courseId) {
            const course = COURSE_DATA[courseId];
            if (!course) return;
            document.getElementById('course-title').innerText = course.title;
            const container = document.getElementById('course-nodes');
            container.innerHTML = '';
            course.phases.forEach(phase => {
                let h = `<div style="margin-top:40px;"><label style="color:var(--accent); font-size:12px; letter-spacing:5px;">${phase.name}</label>`;
                phase.nodes.forEach(node => {
                    const done = localStorage.getItem(node.id) === 'true';
                    h += `<div class="node-item" style="opacity:${done ? 0.4 : 1}; cursor:pointer" onclick="openLab('${node.title}', '${node.id}')">
                            <div class="node-info"><h3>${node.title}</h3><p>Duration: ${node.duration} Minutes</p></div>
                            <div style="color:var(--accent); font-weight:900;">${done ? '✓' : '→'}</div>
                        </div>`;
                });
                container.innerHTML += h + `</div>`;
            });
            navigate('course-view');
        }

        function openLab(title, id) {
            activeNodeId = id;
            document.getElementById('chat-history').innerHTML = '';
            chatHistory = [];
            navigate('ai');
            handleUserInput(`Initialize Protocol: ${title}`);
        }

        function updateHomeStats() {
            let total = 0, done = 0, mins = 0;
            if (typeof COURSE_DATA !== 'undefined') {
                Object.values(COURSE_DATA).forEach(c => c.phases.forEach(p => p.nodes.forEach(n => {
                    total++;
                    if(localStorage.getItem(n.id) === 'true') { done++; mins += parseInt(n.duration); }
                })));
            }
            document.getElementById('home-progress').innerText = (total > 0 ? Math.round((done / total) * 100) : 0) + "%";
            const h = Math.floor(mins / 60), m = mins % 60;
            document.getElementById('home-uptime').innerText = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:00`;
        }

        window.onload = function() {
            updateHomeStats();
            syncVault();
        };
    </script>
</body>
                    </html>
